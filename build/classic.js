(()=>{"use strict";var e={n:t=>{var o=t&&t.__esModule?()=>t.default:()=>t;return e.d(o,{a:o}),o},d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.jQuery;var o=e.n(t);const n=window.wp.hooks,i=window.wp.apiFetch;var a=e.n(i);function s(e){window.addEventListener("message",(async t=>{try{JSON.stringify(t,null,0),await e(t)}catch(e){JSON.stringify(t,null,0),e&&e.stack}}))}const d=window.wp.data,l=(Object.freeze({headlineStudioHasMounted:"headlineStudioHasMounted"}).headlineStudioHasMounted,"cos_headline_score"),r="cos_seo_score",c="cos_headline_text",u="cos_last_analyzed_headline",h="last_headline_score",p="last_headline_text",g="cos_headline_has_been_analyzed";function _(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(o.isClassicEditor)e=window.coscheduleHeadlineStudio?.classicEditorApp?.postId;else{const{id:t}=(0,d.select)("core/editor").getCurrentPost();e=t}try{a()({path:`/cos_headline_studio/v1/set_headline_post_meta/${e}`,method:"POST",data:t})}catch(e){console.log(e)}}function w(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return _(e,t),t.isClassicEditor?null:(0,d.dispatch)("core/editor").editPost({meta:{...e}},t)}function y(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={};return e?t.title=window.coscheduleHeadlineStudio.classicEditorApp.currentHeadline:t=void 0!==(0,d.select)("core/editor").getPostEdits().title?(0,d.select)("core/editor").getPostEdits():(0,d.select)("core/editor").getCurrentPost(),t||{}}function E(e){return e?window.coscheduleHeadlineStudio?.classicEditorApp?.getLastAnalyzedHeadline():("meta",(0,d.select)("core/editor").getEditedPostAttribute("meta")).cos_last_analyzed_headline}function m(e){const t=document.getElementById("headlinestudio-gutenberg-sidebar-iframe");if(t)try{!function(e,t){JSON.stringify(t,null,0),e.postMessage(t,"https://headlines.coschedule.com")}(t.contentWindow,e)}catch(e){console.error(e)}else console.log("handleTitleChange: hsIframe not found")}function S(){m({type:"REANALYZE_FROM_EXTERNAL"})}function A(e){m({type:"UPDATE_STATE",state:{headline:{text:e}}})}function f(e,t){var o;e?.state?.errors?.[0]?.extensions?.code,t&&(window.coscheduleHeadlineStudio.classicEditorApp.updateAlertBanner(e),window.coscheduleHeadlineStudio.classicEditorApp.updateMetaBoxValuesError(null!==(o=e?.state?.errors?.[0]?.extensions?.code)&&void 0!==o?o:"UNKNOWN",e))}async function H(e,t){try{const{state:{fromApp:o,context:n},state:{headline:{text:i,headlineGroupId:a,headlineId:s,score:d,seoScore:_,isInitialAnalyze:y}={}}={}}=e||{},m=await E(t);if(o&&"competitionAnalysis"===n)return w({[l]:d,[c]:i,[r]:_,[u]:{[h]:d,[p]:i,last_seo_score:_},[g]:!0},{isClassicEditor:t}),void(t&&window.coscheduleHeadlineStudio?.classicEditorApp&&window.coscheduleHeadlineStudio.classicEditorApp.updatePublishMetaBoxValues(d,_));o&&d&&i&&w({[l]:d,[c]:i,[u]:{...m,[h]:d,[p]:i},[g]:!0},{isClassicEditor:t})}catch(e){console.error(e)}}async function M(e,t){const{action:o,isMounted:n}=e.state;if("mountStatus"===o){const{title:o}=y(t),{text:i}=e.state.headline;if(t||(0,d.dispatch)("headline-studio-store").setHeadlineStudioHasMounted(),n&&o!==i){A(o);const e=await E(t);w({[l]:0,[r]:0,[c]:"",[u]:e},{isClassicEditor:t})}}}class x{headlineElement;errorMapping;constructor(){this.errorMapping={HEADLINE_LIMIT_REACHED:e=>{let{date:t,upgradeRedirect:o}=e;return["Headline limit reached",`Youâ€™ve reached your basic headline limit. Your plan will reset on ${t}. Or upgrade now to Headline Studio Pro to continue analyzing. <a target="_blank" rel="noopener noreferrer" href="${o}">Upgrade To Pro</a>`]},UNKNOWN:()=>["Something went wrong","Something went wrong"]}}setup(){this.setCurrentHeadline(),function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];s((t=>{const{data:o,origin:n}=t,{type:i}=o;if((n.includes("coschedule.com")||n===window.origin)&&("UPDATE_ERROR"===i&&f(o,e),"UPDATE_STATE"===i&&H(o,e),"EMBED_STATE"===i&&M(o,e),"COS_SAVE_POST_META"===i)){const e=y(),{meta:t}=e;t&&_(t)}}))}(!0),this.onHeadlineStudioLoad=this.onHeadlineStudioLoad.bind(this),(0,n.addAction)("headline_studio_loaded","hs-sidebar",this.onHeadlineStudioLoad,0),this.reanalyzeFromExternal=S,a().use(a().createNonceMiddleware(wpSecurity.nonce))}get currentHeadline(){return this.headlineElement?.value}get postId(){return window.coscheduleHeadlineStudio.currentPostId}onHeadlineStudioLoad(){this.registerTitleChangeListener()}registerTitleChangeListener(){this.headlineElement.addEventListener("keyup",(()=>{this.onTitleChange()}))}async onTitleChange(){const{last_headline_text:e,last_headline_score:t,last_seo_score:o}=await this.getLastAnalyzedHeadline();A(this.headlineElement.value);let n=0,i="",a=0;return this.currentHeadline!==e&&console.log("headlines do not match"),this.currentHeadline===e&&(console.log("headlines match"),i=e,n=t,a=o),w({[c]:i,[l]:n,[r]:a,[u]:{last_headline_text:e,last_headline_score:t,last_seo_score:o}},{isClassicEditor:!0}),this.updatePublishMetaBoxValues(n,a)}triggerAnalyzeFromPostMetaBox(){this.setMetaBoxButtonsToPending(),this.reanalyzeFromExternal()}getMetaBoxNodes(){return{$headlineScore:o()("#meta-option-headline-score"),$seoScore:o()("#meta-option-seo-score")}}setMetaBoxButtonsToPending(){const{$headlineScore:e,$seoScore:t}=this.getMetaBoxNodes();e.text("Analyzing..."),t.text("Analyzing...")}createAnalyzeButton(e){const t=document.createElement("a");return t.role="button",t.innerHTML=e?"Reanalyze":"Analyze",t.className="hide-if-no-js",this.currentHeadline&&(t.href="#",t.onclick=()=>this.triggerAnalyzeFromPostMetaBox()),t}updateAlertBanner(e){var t;const o=null!==(t=e?.state?.errors?.[0]?.extensions?.code)&&void 0!==t?t:"UNKNOWN",n=document.getElementsByClassName("classic-editor-alert-banner")[0];n.style.display="block",n.innerHTML=this.errorMapping[o]?.(e?.state?.userData)[1]}updateMetaBoxValuesError(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"UNKNOWN",t=arguments.length>1?arguments[1]:void 0;("string"!=typeof e||[null,void 0].includes(e))&&(e="UNKNOWN");const{$headlineScore:o,$seoScore:n}=this.getMetaBoxNodes(),i=this.errorMapping[e](t?.state?.userData)[0];o.html(i),n.html(i)}async updatePublishMetaBoxValues(e,t){const{$headlineScore:o,$seoScore:n}=this.getMetaBoxNodes(),{last_headline_text:i}=await this.getLastAnalyzedHeadline();e?o.html(`<strong>${e}</strong>`):o.html(this.createAnalyzeButton(i)),t?n.html(`<strong>${t}</strong>`):n.html(this.createAnalyzeButton(i))}async getPostMeta(){let e;if(!this.postId)return null;try{e=await wp.apiFetch({path:`/cos_headline_studio/v1/get_headline_post_meta/${this.postId}`,method:"GET"})}catch(e){console.error("Could not fetch post meta")}return e}async getLastAnalyzedHeadline(){return(await this.getPostMeta())?.cos_last_analyzed_headline}setCurrentHeadline(){this.headlineElement=document.querySelector('#titlewrap > input[id="title"]')}}o()((()=>{window.coscheduleHeadlineStudio.classicEditorApp=new x,window.coscheduleHeadlineStudio.classicEditorApp.setup()})),o()(window).on("load",(()=>{o().when(o().ready).then((()=>{(0,n.doAction)("headline_studio_loaded")}))}))})();